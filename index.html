import logging
import requests
import sqlite3
import os
from telegram import Update
from telegram.ext import Updater, CommandHandler, CallbackContext

# Set up logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Telegram API Token (You can set this in Heroku config variables)
API_TOKEN = os.getenv("TELEGRAM_API_TOKEN")

# SQLite Database Functions
def create_table():
    """Create the SQLite database table if it doesn't exist."""
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS users
                      (user_id INTEGER PRIMARY KEY, 
                       preference TEXT)''')
    conn.commit()
    conn.close()

def set_preference(user_id, preference):
    """Set user preference in the SQLite database."""
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    cursor.execute('''INSERT OR REPLACE INTO users (user_id, preference)
                      VALUES (?, ?)''', (user_id, preference))
    conn.commit()
    conn.close()

def get_preference(user_id):
    """Get user preference from the SQLite database."""
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    cursor.execute('''SELECT preference FROM users WHERE user_id = ?''', (user_id,))
    result = cursor.fetchone()
    conn.close()
    if result:
        return result[0]
    return None

# Fetch a motivational quote
def get_motivational_quote():
    """Fetch a random motivational quote."""
    response = requests.get("https://api.quotable.io/random")
    data = response.json()
    return data['content']

# Fetch a Quranic verse
def get_quranic_verse():
    """Fetch a specific Quranic verse (Ayat-ul-Kursi)."""
    response = requests.get("https://api.alquran.cloud/v1/ayah/2:255")
    data = response.json()
    verse = data['data']['text']
    tafsir = "Tafsir: This is Ayat-ul-Kursi, which speaks about Allah's sovereignty."
    return f"Quranic Verse: {verse}\n\n{tafsir}"

# Send daily quote or verse based on user preference
def send_daily_quote(update: Update, context: CallbackContext):
    """Send a daily quote or Quranic verse based on user preference."""
    user_id = update.message.from_user.id
    preference = get_preference(user_id) or "motivation"  # Default to motivation

    if preference == "motivation":
        quote = get_motivational_quote()
        update.message.reply_text(f"Your Daily Motivation:\n\n{quote}")
    elif preference == "quran":
        verse = get_quranic_verse()
        update.message.reply_text(f"Your Daily Quranic Verse:\n\n{verse}")
    else:
        update.message.reply_text("Please choose between 'motivation' or 'quran'.")

# Change user preferences
def set_user_preference(update: Update, context: CallbackContext):
    """Change the userâ€™s daily content preference."""
    user_id = update.message.from_user.id
    if context.args:
        preference = context.args[0]
        if preference in ['motivation', 'quran']:
            set_preference(user_id, preference)
            update.message.reply_text(f"Your daily content preference has been set to: {preference}")
        else:
            update.message.reply_text("Invalid choice. Choose 'motivation' or 'quran'.")
    else:
        update.message.reply_text("Please provide a preference: /setpreference motivation or /setpreference quran")

# Start command to guide users
def start(update: Update, context: CallbackContext):
    """Send the start message and basic instructions."""
    update.message.reply_text(
        'Welcome! Use /setpreference motivation or /setpreference quran to set your daily content.\n\n'
        'Use /quote to get your daily content.'
    )

# Main function to set up the bot
def main():
    """Main function to set up and run the bot."""
    # Initialize the SQLite database
    create_table()

    # Set up the Updater and Dispatcher
    updater = Updater(API_TOKEN, use_context=True)
    dp = updater.dispatcher

    # Add Command Handlers
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("quote", send_daily_quote))
    dp.add_handler(CommandHandler("setpreference", set_user_preference))

    # Start the bot and keep it running
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
